<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Plant Analyzer">
    <title>Plant Nutrient Analyzer</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { overscroll-behavior-y: contain; }
        .camera-button { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-emerald-100 min-h-screen">
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect } = React;

        ```
    function PlantAnalyzer() {
        const [selectedImage, setSelectedImage] = useState(null);
        const [imagePreview, setImagePreview] = useState(null);
        const [analysis, setAnalysis] = useState(null);
        const [loading, setLoading] = useState(false);
        const [processing, setProcessing] = useState(false);
        const [error, setError] = useState(null);
        const [installPrompt, setInstallPrompt] = useState(null);
        const [showInstallBanner, setShowInstallBanner] = useState(false);
        const [imageSize, setImageSize] = useState(null);

        useEffect(() => {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                setInstallPrompt(e);
                setShowInstallBanner(true);
            });
        }, []);

        const handleInstallClick = async () => {
            if (!installPrompt) return;
            installPrompt.prompt();
            const { outcome } = await installPrompt.userChoice;
            if (outcome === 'accepted') setShowInstallBanner(false);
            setInstallPrompt(null);
        };

        // Compress and resize image
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                setProcessing(true);
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Maximum dimensions
                        const MAX_WIDTH = 1024;
                        const MAX_HEIGHT = 1024;
                        
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height = height * (MAX_WIDTH / width);
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width = width * (MAX_HEIGHT / height);
                                height = MAX_HEIGHT;
                            }
                        }

                        // Create canvas and draw resized image
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to blob with compression
                        canvas.toBlob(
                            (blob) => {
                                const compressedFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                
                                // Show file sizes
                                const originalSize = (file.size / 1024).toFixed(2);
                                const compressedSize = (compressedFile.size / 1024).toFixed(2);
                                setImageSize({
                                    original: originalSize,
                                    compressed: compressedSize,
                                    savings: ((1 - compressedFile.size / file.size) * 100).toFixed(0)
                                });
                                
                                setProcessing(false);
                                resolve(compressedFile);
                            },
                            'image/jpeg',
                            0.85 // 85% quality - good balance
                        );
                    };
                    
                    img.onerror = () => {
                        setProcessing(false);
                        reject(new Error('Failed to load image'));
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.onerror = () => {
                    setProcessing(false);
                    reject(new Error('Failed to read file'));
                };
                
                reader.readAsDataURL(file);
            });
        };

        const processImage = async (file) => {
            if (!file) return;
            
            setError(null);
            setAnalysis(null);
            setImageSize(null);
            
            try {
                // Compress the image first
                const compressedFile = await compressImage(file);
                setSelectedImage(compressedFile);
                
                // Create preview
                const reader = new FileReader();
                reader.onloadend = () => setImagePreview(reader.result);
                reader.readAsDataURL(compressedFile);
            } catch (err) {
                setError('Failed to process image: ' + err.message);
                setProcessing(false);
            }
        };

        const analyzeImage = async () => {
            if (!selectedImage) return;
            setLoading(true);
            setError(null);
            setAnalysis(null);

            try {
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const base64Data = reader.result.split(',')[1];
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            imageData: base64Data,
                            imageType: selectedImage.type
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Server error: ${response.status}`);
                    }

                    const analysisData = await response.json();
                    setAnalysis(analysisData);
                    setLoading(false);
                };
                reader.readAsDataURL(selectedImage);
            } catch (err) {
                setError(err.message || 'Failed to analyze image. Try again in a few seconds.');
                setLoading(false);
            }
        };

        const getSeverityColor = (severity) => {
            const colors = {
                mild: 'bg-yellow-100 text-yellow-800 border-yellow-300',
                moderate: 'bg-orange-100 text-orange-800 border-orange-300',
                severe: 'bg-red-100 text-red-800 border-red-300'
            };
            return colors[severity?.toLowerCase()] || 'bg-gray-100 text-gray-800 border-gray-300';
        };

        const getHealthColor = (health) => {
            const colors = {
                excellent: 'text-green-600',
                good: 'text-lime-600',
                fair: 'text-yellow-600',
                poor: 'text-red-600'
            };
            return colors[health?.toLowerCase()] || 'text-gray-600';
        };

        return (
            <div className="container mx-auto px-4 py-6 max-w-4xl pb-20">
                {showInstallBanner && (
                    <div className="fixed top-0 left-0 right-0 bg-emerald-600 text-white p-4 shadow-lg z-50">
                        <div className="flex items-center justify-between max-w-4xl mx-auto">
                            <div className="flex items-center space-x-3">
                                <span className="text-2xl">üå±</span>
                                <div>
                                    <p className="font-semibold">Install Plant Analyzer</p>
                                    <p className="text-xs text-emerald-100">Use offline like a native app!</p>
                                </div>
                            </div>
                            <div className="flex space-x-2">
                                <button onClick={handleInstallClick} className="bg-white text-emerald-600 px-4 py-2 rounded-lg font-semibold text-sm">Install</button>
                                <button onClick={() => setShowInstallBanner(false)} className="text-white px-2">‚úï</button>
                            </div>
                        </div>
                    </div>
                )}

                <div className={`bg-white rounded-2xl shadow-xl p-6 ${showInstallBanner ? 'mt-24' : ''}`}>
                    <div className="text-center mb-6">
                        <h1 className="text-3xl md:text-4xl font-bold text-emerald-800 mb-2">üå± Plant Analyzer</h1>
                        <p className="text-gray-600 text-sm md:text-base">Detect nutrient deficiencies with AI</p>
                    </div>

                    <div className="mb-6 space-y-4">
                        <label className="camera-button flex items-center justify-center w-full py-4 rounded-xl cursor-pointer shadow-md text-white font-semibold">
                            <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Take Photo
                            <input type="file" className="hidden" accept="image/*" capture="environment" onChange={(e) => e.target.files[0] && processImage(e.target.files[0])} />
                        </label>

                        <label className="flex items-center justify-center w-full py-4 border-2 border-emerald-300 border-dashed rounded-xl cursor-pointer bg-emerald-50 hover:bg-emerald-100 transition-colors">
                            <svg className="w-6 h-6 mr-2 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <span className="text-emerald-700 font-semibold">Choose from Gallery</span>
                            <input type="file" className="hidden" accept="image/*" onChange={(e) => e.target.files[0] && processImage(e.target.files[0])} />
                        </label>

                        {processing && (
                            <div className="text-center py-4">
                                <div className="inline-flex items-center space-x-2 text-emerald-600">
                                    <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                                    </svg>
                                    <span className="font-medium">Optimizing image...</span>
                                </div>
                            </div>
                        )}

                        {imagePreview && !processing && (
                            <div className="space-y-2">
                                <div className="relative rounded-xl overflow-hidden border-2 border-emerald-200">
                                    <img src={imagePreview} alt="Plant preview" className="w-full h-64 object-cover" />
                                    <button onClick={() => { setImagePreview(null); setSelectedImage(null); setAnalysis(null); setImageSize(null); }} className="absolute top-2 right-2 bg-red-500 text-white rounded-full p-2 shadow-lg">
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                {imageSize && (
                                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                        <p className="text-xs text-blue-800">
                                            <strong>‚ú® Image optimized:</strong> {imageSize.original}KB ‚Üí {imageSize.compressed}KB 
                                            <span className="text-blue-600"> ({imageSize.savings}% smaller)</span>
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    <button onClick={analyzeImage} disabled={!selectedImage || loading || processing} className="w-full bg-emerald-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-emerald-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors shadow-md">
                        {loading ? (
                            <span className="flex items-center justify-center">
                                <svg className="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                                </svg>
                                Analyzing...
                            </span>
                        ) : 'Analyze Plant'}
                    </button>

                    {error && (
                        <div className="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                            <p className="text-red-700 text-sm">‚ö†Ô∏è {error}</p>
                        </div>
                    )}

                    {analysis && (
                        <div className="mt-8 space-y-6">
                            <div className="bg-gradient-to-r from-emerald-50 to-teal-50 p-6 rounded-xl border border-emerald-200">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <p className="text-sm text-gray-600 mb-1">Plant Type</p>
                                        <p className="text-lg font-semibold text-emerald-800">{analysis.plantType}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-600 mb-1">Overall Health</p>
                                        <p className={`text-lg font-semibold capitalize ${getHealthColor(analysis.overallHealth)}`}>{analysis.overallHealth}</p>
                                    </div>
                                </div>
                            </div>

                            {analysis.deficiencies?.length > 0 && (
                                <div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-4">üîç Detected Deficiencies</h3>
                                    <div className="space-y-4">
                                        {analysis.deficiencies.map((def, idx) => (
                                            <div key={idx} className={`p-4 rounded-lg border-2 ${getSeverityColor(def.severity)}`}>
                                                <div className="flex justify-between items-start mb-2">
                                                    <h4 className="font-bold text-lg">{def.nutrient}</h4>
                                                    <span className="text-xs font-semibold px-2 py-1 rounded uppercase">{def.severity}</span>
                                                </div>
                                                <p className="text-sm mb-2">{def.symptoms}</p>
                                                <p className="text-xs opacity-75">Confidence: {def.confidence}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {analysis.recommendations?.length > 0 && (
                                <div>
                                    <h3 className="text-xl font-bold text-gray-800 mb-4">üí° Recommendations</h3>
                                    <div className="bg-blue-50 p-5 rounded-lg border border-blue-200">
                                        <ul className="space-y-2">
                                            {analysis.recommendations.map((rec, idx) => (
                                                <li key={idx} className="flex items-start">
                                                    <

</body>
</html>
